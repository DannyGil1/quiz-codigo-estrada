<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quiz - Código de Estrada de Angola</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Container do Quiz -->
  <div class="quiz-container borda-padrao" id="quiz">
    <h1 id="tituloQuiz">Quiz</h1>
    <p id="pergunta"></p>
    <div id="opcoes"></div>
    <button id="proxima" class="botao-padrao" disabled>Próxima</button>
  </div>

  <!-- Container de Resultado -->
  <div class="quiz-container borda-padrao" id="resultado-container" style="display:none;">
    <h1>Resultado</h1>
    <p id="resultado"></p>
    <div class="navegacao">
      <button class="botao-padrao" onclick="window.location.href='index.html'">Voltar ao Menu</button>
    </div>
  </div>

  <!-- Script para pegar parâmetros -->
  <script>
    function getParametroURL(nome) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(nome);
    }

    const cap = getParametroURL('cap');
    const art = getParametroURL('art');

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("tituloQuiz").textContent =
        `Capítulo ${cap} - Artigo ${art}`;
    });

    // Carrega dinamicamente o ficheiro correto do capítulo
    const scriptCapitulo = document.createElement("script");
    scriptCapitulo.src = `dados/capitulo${cap}.js`;
    scriptCapitulo.onload = () => {
      const nomeArtigo = `artigo${art}`;
      if (window[nomeArtigo] && Array.isArray(window[nomeArtigo])) {
        const questoesSelecionadas = embaralhar([...window[nomeArtigo]]).slice(0, 5);
        iniciarQuiz(questoesSelecionadas, mostrarResultado);
      } else {
        alert("Este artigo ainda não está disponível.");
        window.location.href = `artigos.html?cap=${cap}`;
      }
    };
    scriptCapitulo.onerror = () => {
      alert("Capítulo não encontrado.");
      window.location.href = "capitulos.html";
    };
    document.head.appendChild(scriptCapitulo);
  </script>

  <!-- Script principal corrigido -->
  <script>
    let indicePergunta = 0;
    let pontuacao = 0;
    let questoes = [];

    function embaralhar(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function iniciarQuiz(listaQuestoes, callbackFinal) {
      questoes = listaQuestoes;
      indicePergunta = 0;
      pontuacao = 0;
      mostrarPergunta(callbackFinal);
    }

    function mostrarPergunta(callbackFinal) {
      const perguntaElemento = document.getElementById("pergunta");
      const opcoesElemento = document.getElementById("opcoes");
      const botaoProxima = document.getElementById("proxima");

      botaoProxima.disabled = true;
      opcoesElemento.innerHTML = "";

      if (indicePergunta < questoes.length) {
        let perguntaAtual = questoes[indicePergunta];
        perguntaElemento.textContent = perguntaAtual.pergunta;

        perguntaAtual.opcoes.forEach((opcao, index) => {
          const botao = document.createElement("button");
          botao.textContent = opcao;
          botao.classList.add("opcao");
          botao.onclick = () => selecionarOpcao(index, perguntaAtual.correta, perguntaAtual.opcoes, botaoProxima);
          opcoesElemento.appendChild(botao);
        });

        botaoProxima.onclick = () => {
          indicePergunta++;
          mostrarPergunta(callbackFinal);
        };
      } else {
        callbackFinal(pontuacao, questoes.length);
      }
    }

    function selecionarOpcao(indiceSelecionado, correta, listaOpcoes, botaoProxima) {
      const botoes = document.querySelectorAll(".opcao");

      let indiceCorreto;
      if (typeof correta === "number") {
        indiceCorreto = correta;
      } else {
        indiceCorreto = listaOpcoes.findIndex(opcao =>
          opcao.trim().toLowerCase() === correta.trim().toLowerCase()
        );
      }

      botoes.forEach((botao, index) => {
        botao.disabled = true;
        if (index === indiceCorreto) {
          botao.classList.add("correta");
        } else if (index === indiceSelecionado) {
          botao.classList.add("errada");
        }
      });

      if (indiceSelecionado === indiceCorreto) {
        pontuacao++;
      }

      botaoProxima.disabled = false;
    }

    function mostrarResultado(pontos, total) {
      document.getElementById("quiz").style.display = "none";
      const resultadoContainer = document.getElementById("resultado-container");
      resultadoContainer.style.display = "block";

      document.getElementById("resultado").textContent =
        `Você acertou ${pontos} de ${total} questões.`;
    }
  </script>
</body>
</html>
